{% comment %}
  SECTION: MAIN VITALBLEND PRODUCT
  Version: Final Release (Pupford Style Layout with Media Gallery)
  Author: Luis Portugal
{% endcomment %}

<div class="vitalblend-wrapper">
  <div class="vb-gallery">
    {% if product.media.size > 1 %}
      <div class="vb-thumbnails-column">
        {% for media in product.media %}
          <button
            class="vb-thumb-btn {% if media.id == product.featured_image.id %}active{% endif %}"
            data-media-id="{{ media.id }}"
            onclick="changeMainImage('{{ media.preview_image | image_url: width: 1000, height: 1000 }}', this)"
          >
            <img
              src="{{ media.preview_image | image_url: width: 150, height: 150 }}"
              width="150"
              height="150"
              loading="lazy"
              alt="{{ media.alt | escape }}"
            >
          </button>
        {% endfor %}
      </div>
    {% endif %}

    <div class="vb-main-image-container">
      <img
        id="ProductImage"
        src="{{ product.featured_image | image_url: width: 1000, height: 1000 }}"
        width="1000"
        height="1000"
        alt="{{ product.title | escape }}"
        data-media-id="{{ product.featured_image.id }}"
      >
    </div>
  </div>

  <div class="vb-info">
    <div class="vb-reviews">
      <span style="color: #FFB800; letter-spacing: 2px;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <span class="vb-review-count">1,240 Reviews</span>
    </div>

    <h1 class="vb-title">{{ product.title }}</h1>

    <div class="vb-price-container">
      <span id="ProductPrice" class="vb-price">{{ product.price | money }}</span>
      <span id="ComparePrice" class="vb-compare-price" style="display:none;"></span>
      <span id="SaveBadge" class="vb-save-badge" style="display:none;">{{ section.settings.sub_discount_badge }}</span>
    </div>

    <div class="vb-badges-row">
      <div class="vb-badge-pill"><span class="vb-badge-dot"></span> Simple Ingredients</div>
      <div class="vb-badge-pill"><span class="vb-badge-dot"></span> Made in USA</div>
      <div class="vb-badge-pill"><span class="vb-badge-dot"></span> No Fillers</div>
    </div>

    {% form 'product', product %}
      <input
        type="hidden"
        name="id"
        id="SelectedVariantId"
        value="{{ product.selected_or_first_available_variant.id }}"
      >

      <div class="vb-options">
        {% for option in product.options_with_values %}
          <fieldset class="vb-option-group">
            <legend class="vb-option-label">
              {{ option.name }}: <span id="Label-{{ option.name }}">{{ option.selected_value }}</span>
            </legend>
            <div class="vb-pills">
              {% for value in option.values %}
                <label class="vb-pill">
                  <input
                    type="radio"
                    name="{{ option.name }}"
                    value="{{ value | escape }}"
                    {% if option.selected_value == value %}
                      checked
                    {% endif %}
                    onchange="updateVariantState(this)"
                  >
                  <span>{{ value }}</span>
                </label>
              {% endfor %}
            </div>
          </fieldset>
        {% endfor %}

        <!-- DYNAMIC VARIANT HIGHLIGHT -->
        <div id="VariantHighlight" class="vb-variant-highlight" style="display: none;">
          <span class="vb-highlight-icon">‚ú®</span>
          <span id="VariantHighlightText"></span>
        </div>
      </div>

      <div class="vb-purchase-type-container">
        <label class="vb-purchase-option active" id="OptionOneTime" onclick="setPurchaseType('onetime')">
          <input type="radio" name="purchase_mode" value="onetime" checked style="display:none;">
          <div class="vb-radio-circle"></div>
          <div class="vb-option-content">
            <div class="vb-option-header">
              <span class="vb-option-title">One-time purchase</span>
              <span class="vb-option-price" id="PriceOneTime">{{ product.price | money }}</span>
            </div>
          </div>
        </label>

        <label class="vb-purchase-option" id="OptionSub" onclick="setPurchaseType('subscription')">
          <input type="radio" name="purchase_mode" value="subscription" style="display:none;">
          <div class="vb-radio-circle"></div>
          <div class="vb-option-content">
            <div class="vb-option-header">
              <div class="vb-option-title-group">
                <span class="vb-option-title">{{ section.settings.sub_text }}</span>
                <span class="vb-option-savings">Save {{ section.settings.sub_discount_badge }}</span>
              </div>
              <span class="vb-option-price" id="PriceSub">{{ product.price | times: 0.9 | money }}</span>
            </div>
            <div class="vb-option-extras">
              <span class="vb-extra-tag">‚úì Best Value</span>
              <span class="vb-extra-tag">‚úì Free Shipping</span>
              <span class="vb-extra-tag">‚úì Cancel Anytime</span>
            </div>
          </div>
        </label>

        <div id="SubscriptionFrequency" class="vb-frequency-selector" style="display:none;">
          <label>Deliver every:</label>
          <select name="properties[Shipping Frequency]" class="vb-select" disabled>
            <option value="30 Days">30 Days (Most Popular)</option>
            <option value="45 Days">45 Days</option>
            <option value="60 Days">60 Days</option>
          </select>
        </div>
      </div>

      <div class="vb-actions">
        <div class="vb-quantity">
          <input type="number" name="quantity" value="1" min="1" aria-label="Quantity">
        </div>
        <button type="submit" name="add" id="AddToCart" class="vb-btn-add">Add to Cart</button>
      </div>

      <!-- DESKTOP TABS -->
      <div class="vb-product-tabs">
        <div class="vb-tab-header">
          <button type="button" class="vb-tab-link active" onclick="openTab(event, 'Description')">Description</button>
          <button type="button" class="vb-tab-link" onclick="openTab(event, 'Nutrition')">Nutrition</button>
          <button type="button" class="vb-tab-link" onclick="openTab(event, 'Feeding')">Feeding Guide</button>
        </div>

        <div id="Description" class="vb-tab-content active" style="display: block;">
          <div class="vb-description-inner">{{ product.description }}</div>
        </div>

        <div id="Nutrition" class="vb-tab-content">
          <div class="vb-description-inner">
            <strong>Fuel for Peak Performance</strong>
            <p>VitalBlend uses 100% human-grade, bioavailable protein sources. No fillers, just fuel.</p>
            <ul>
              <li>High protein density (25g per serving)</li>
              <li>Natural Electrolytes for hydration</li>
              <li>Zero added sugar or artificial colors</li>
            </ul>
          </div>
        </div>

        <div id="Feeding" class="vb-tab-content">
          <div class="vb-description-inner">
            <strong>Usage Instructions</strong>
            <p>Mix 1 scoop with 8-10oz of cold water or your favorite nut milk. Shake well for 20 seconds.</p>
            <p>
              <em>Pro Tip: Use after workouts or as a morning protein boost to sustain energy throughout the day.</em>
            </p>
          </div>
        </div>
      </div>

      <script type="application/json" id="ProductVariantsJson">
        {{ product.variants | json }}
      </script>
    {% endform %}

    <!-- FREQUENTLY BOUGHT TOGETHER SECTION -->
    {% liquid
      assign cross_product = section.settings.cross_sell_product
      if cross_product == blank
        # Fallback 1: Try same collection
        for collection in product.collections limit: 1
          for prod in collection.products limit: 10
            if prod.id != product.id and prod.available
              assign cross_product = prod
              break
            endif
          endfor
        endfor

        # Fallback 2: Try ALL products if still empty
        if cross_product == blank
          for prod in collections.all.products limit: 10
            if prod.id != product.id and prod.available
              assign cross_product = prod
              break
            endif
          endfor
        endif
      endif

      # Fallback 3: Mock data for preview if store is empty
      if cross_product == blank
        assign cross_product_title = 'VitalBlend Recovery Treats'
        assign cross_product_price = 1499
      else
        assign cross_product_title = cross_product.title
        assign cross_product_price = cross_product.price
        assign cross_product_id = cross_product.selected_or_first_available_variant.id
      endif
    %}

    {% if cross_product != blank or cross_product_title != blank %}
      <div class="vb-cross-sell-container">
        <h3>Frequently Bought Together</h3>
        <div class="vb-cross-sell-wrapper">
          <div class="vb-cross-items">
            <div class="vb-cross-item">
              <img
                src="{{ product.featured_image | image_url: width: 200 }}"
                alt="{{ product.title }}"
                width="200"
                height="200"
                loading="lazy"
              >
              <div class="vb-plus">+</div>
            </div>
            <div class="vb-cross-item">
              {% if cross_product != blank %}
                <img
                  src="{{ cross_product.featured_image | image_url: width: 200 }}"
                  alt="{{ cross_product_title }}"
                  width="200"
                  height="200"
                  loading="lazy"
                >
              {% else %}
                <img
                  src="{{ 'raw-chicken-breast.png' | asset_url }}"
                  alt="{{ cross_product_title }}"
                  width="200"
                  height="200"
                  loading="lazy"
                >
              {% endif %}
            </div>
          </div>

          <div class="vb-cross-info">
            <div class="vb-cross-total">
              <span>Total Price:</span>
              <strong id="CrossSellTotal">{{ product.price | plus: cross_product_price | money }}</strong>
            </div>
            <button
              type="button"
              class="vb-btn-cross-add"
              {% if cross_product_id %}
                onclick="addCrossSellToCart('{{ product.selected_or_first_available_variant.id }}', '{{ cross_product_id }}')"
              {% else %}
                onclick="alert('This is a preview. Add a real product in Shopify Admin to enable cart.')"
              {% endif %}
            >
              Add Both to Cart
            </button>
            <p class="vb-cross-note">
              <strong>{{ cross_product_title }}</strong>
              <br>
              <span class="vb-small-price">+ {{ cross_product_price | money }}</span>
            </p>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- STICKY BUY BAR -->
<div id="StickyBuyBar" class="vb-sticky-bar">
  <div class="vb-sticky-container">
    <div class="vb-sticky-product">
      <img
        src="{{ product.featured_image | image_url: width: 100, height: 100 }}"
        width="50"
        height="50"
        alt="{{ product.title }}"
      >
      <div class="vb-sticky-info">
        <span class="vb-sticky-title">{{ product.title }}</span>
        <div class="vb-sticky-price-row">
          <span id="StickyPrice" class="vb-sticky-price">{{ product.price | money }}</span>
        </div>
      </div>
    </div>
    <button type="button" class="vb-sticky-atc" onclick="document.getElementById('AddToCart').click()">
      Add to Cart
    </button>
  </div>
</div>

<div class="vb-sections-container">
  {% if product.metafields.custom.promotional_headline != blank %}
    <div class="vb-section-block vb-headline-block">
      <h2>{{ product.metafields.custom.promotional_headline | escape }}</h2>
    </div>
  {% endif %}

  <!-- INGREDIENTS VISUAL BREAKDOWN -->
  <div class="vb-section-block vb-ingredients-visual">
    <h3>Supercharged Ingredients</h3>
    <div class="vb-ingredients-grid">
      <div class="vb-ingredient-card">
        <div class="vb-ingredient-image-wrapper">
          <img
            src="{{ 'raw-chicken-breast.png' | asset_url }}"
            alt="Whey Isolate"
            loading="lazy"
            width="400"
            height="400"
          >
        </div>
        <div class="vb-ingredient-info">
          <h4>Premium Whey Isolate</h4>
          <p>Ultra-filtered protein for maximum absorption and rapid muscle recovery.</p>
        </div>
      </div>

      <div class="vb-ingredient-card">
        <div class="vb-ingredient-image-wrapper">
          <img src="{{ 'sweet-potato.png' | asset_url }}" alt="Organic Matcha" loading="lazy" width="400" height="400">
        </div>
        <div class="vb-ingredient-info">
          <h4>Organic Ceremonial Matcha</h4>
          <p>L-Theanine rich energy for sustained focus without the caffeine crash.</p>
        </div>
      </div>

      <div class="vb-ingredient-card">
        <div class="vb-ingredient-image-wrapper">
          <img
            src="{{ 'rosemary-oil.png' | asset_url }}"
            alt="Ashwagandha"
            loading="lazy"
            width="400"
            height="400"
          >
        </div>
        <div class="vb-ingredient-info">
          <h4>Ashwagandha Root</h4>
          <p>Ancient adaptogen to help your body manage stress and optimize performance.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="vb-section-block vb-icons-block">
    <div class="vb-icons-grid">
      <div class="vb-icon-item">
        <span class="vb-icon-emoji" role="img" aria-label="seedling">üå±</span>
        <span>Simple Ingredients</span>
      </div>
      <div class="vb-icon-item">
        <span class="vb-icon-emoji" role="img" aria-label="flag">üá∫üá∏</span>
        <span>Made in USA</span>
      </div>
      <div class="vb-icon-item">
        <span class="vb-icon-emoji" role="img" aria-label="down arrow">‚¨áÔ∏è</span>
        <span>Low Calorie</span>
      </div>
      <div class="vb-icon-item">
        <span class="vb-icon-emoji" role="img" aria-label="prohibited">üö´</span>
        <span>No Fillers</span>
      </div>
    </div>
  </div>

  {% if product.metafields.custom.how_to_use_steps.value != blank %}
    <div class="vb-section-block vb-how-to-use-block">
      <h3>How to Use</h3>
      <div class="vb-steps-grid">
        {% for step in product.metafields.custom.how_to_use_steps.value %}
          <div class="vb-step-card">
            <div class="vb-step-icon-placeholder">
              {% if step.icon != blank %}
                <img
                  src="{{ step.icon | image_url: width: 80, height: 80 }}"
                  width="80"
                  height="80"
                  alt="{{ step.title | escape }}"
                >
              {% else %}
                <span>‚úì</span>
              {% endif %}
            </div>
            <div class="vb-step-text">
              <strong>{{ step.title | escape }}</strong>
              <p>{{ step.description | escape }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

{% style %}
  /* --- MAIN LAYOUT --- */
  .vitalblend-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Split 50/50 */
    gap: 4rem;
    max-width: 1200px;
    margin: 3rem auto;
    padding: 0 20px;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: #222;
    align-items: start;
  }

  /* --- MEDIA GALLERY STYLES --- */
  .vb-gallery {
    display: flex;
    flex-direction: row; /* Horizontal layout for desktop */
    gap: 20px;
  }
  .vb-thumbnails-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 80px;
    flex-shrink: 0;
  }
  .vb-main-image-container {
    flex-grow: 1;
  }
  .vb-main-image-container img {
    width: 100%;
    height: auto;
    border-radius: 12px;
    background: #f4f4f4;
    object-fit: cover;
  }
  .vb-thumb-btn {
    width: 80px;
    height: 80px;
    padding: 0;
    border: 2px solid transparent;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    background: #f4f4f4;
    transition: all 0.2s ease;
  }
  .vb-thumb-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .vb-thumb-btn.active {
    border-color: #000;
  }

  /* --- TYPOGRAPHY & PRICING --- */
  .vb-title { font-size: 3rem; margin: 10px 0 20px; line-height: 1; letter-spacing: -1px; }

  .vb-reviews { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .vb-review-count { text-decoration: underline; color: #666; font-size: 0.9rem;}

  .vb-price { font-size: 2.5rem; font-weight: 700; color: #000; }
  .vb-price-container { margin-bottom: 1rem; display: flex; align-items: center; gap: 15px; }
  .vb-save-badge { background: #E53935; color: white; padding: 5px 10px; font-weight: bold; text-transform: uppercase; font-size: 0.9rem; border-radius: 4px;}
  .vb-compare-price { font-size: 1.5rem; color: #888; text-decoration: line-through; }

  /* --- BADGES --- */
  .vb-badges-row { display: flex; gap: 12px; margin-bottom: 2rem; flex-wrap: wrap; }
  .vb-badge-pill {
    background: #fdf6e3; color: #856404; font-size: 0.85rem; font-weight: 600; padding: 6px 12px; border-radius: 20px;
    display: flex; align-items: center; gap: 6px; border: 1px solid #ffeeba;
  }
  .vb-badge-dot { width: 6px; height: 6px; background: #856404; border-radius: 50%; }

  /* --- VARIANT SELECTORS (Pills) --- */
  .vb-pills { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
  /* Hides the native radio button circle */
  .vb-pill input { display: none; }
  .vb-pill span {
    display: block;
    padding: 12px 25px;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
  }
  .vb-pill input:checked + span { border-color: #000; background: #000; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
  .vb-option-label { font-weight: bold; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
  .vb-option-group { margin-bottom: 1.5rem; border: none; padding: 0; }

  .vb-variant-highlight {
    background: #fdf2f2;
    border-left: 3px solid #E53935;
    padding: 10px 15px;
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-radius: 4px;
    font-size: 0.95rem;
    color: #111;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  .vb-highlight-icon { font-size: 1.1rem; }

  /* --- SUBSCRIPTION WIDGET --- */
  .vb-purchase-type-container { margin: 2rem 0; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
  .vb-purchase-option { display: flex; align-items: flex-start; padding: 20px; cursor: pointer; border-bottom: 1px solid #eee; transition: all 0.2s; border-left: 6px solid transparent; }
  .vb-purchase-option:last-of-type { border-bottom: none; }
  .vb-purchase-option.active { background: #fdfdfd; border-left-color: #E53935; } /* ACTIVE STATE RED BORDER */

  .vb-radio-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; margin-right: 15px; position: relative; flex-shrink: 0; margin-top: 2px; }
  .vb-purchase-option.active .vb-radio-circle { border-color: #000; }
  .vb-purchase-option.active .vb-radio-circle::after { content:''; position: absolute; top:3px; left:3px; width:10px; height:10px; background:#000; border-radius:50%; }

  .vb-option-content { flex-grow: 1; }
  .vb-option-header { display: flex; justify-content: space-between; align-items: flex-start; }
  .vb-option-title { font-weight: 700; font-size: 1.1rem; color: #111; }
  .vb-option-price { font-weight: 700; color: #000; font-size: 1.1rem; }

  .vb-option-title-group { display: flex; flex-direction: column; gap: 4px; }
  .vb-option-savings { color: #E53935; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }

  .vb-option-extras { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .vb-extra-tag { font-size: 0.8rem; color: #2e7d32; font-weight: 600; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; }

  .vb-frequency-selector { background: #f1f1f1; padding: 15px 20px; border-top: 1px solid #ddd;}
  .vb-select { width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px;}

  /* --- ACTIONS (Add to Cart) --- */
  .vb-actions { display: flex; gap: 10px; height: 55px; margin-top: 2rem; }
  .vb-quantity input { height: 100%; width: 70px; text-align: center; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 6px; }
  .vb-btn-add { flex: 1; background: {{ section.settings.btn_color }}; color: white; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; transition: opacity 0.2s;}
  .vb-btn-add:hover { opacity: 0.9; }

  /* --- TABS SYSTEM --- */
  .vb-product-tabs { margin-top: 3rem; border-top: 1px solid #eee; padding-top: 2rem;}
  .vb-tab-header { display: flex; gap: 25px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
  .vb-tab-link {
    background: none; border: none; padding: 10px 0; font-size: 1.1rem; font-weight: 600; cursor: pointer; color: #888; border-bottom: 2px solid transparent;
    transition: all 0.3s;
  }
  .vb-tab-link:hover { color: #000; }
  .vb-tab-link.active { color: #000; border-bottom-color: #000; }
  .vb-tab-content { display: none; }
  .vb-tab-content.active { display: block; animation: fadeIn 0.4s; }
  .vb-description-inner { line-height: 1.6; font-size: 1.1rem; color: #444; }

  /* --- STICKY BUY BAR --- */
  .vb-sticky-bar {
    position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); padding: 15px 0; z-index: 999;
    transform: translateY(100%); transition: transform 0.3s ease-in-out;
  }
  .vb-sticky-bar.visible { transform: translateY(0); }
  .vb-sticky-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
  .vb-sticky-product { display: flex; align-items: center; gap: 15px; }
  .vb-sticky-product img { border-radius: 5px; background: #f4f4f4; border: 1px solid #eee;}
  .vb-sticky-info { display: flex; flex-direction: column; }
  .vb-sticky-title { font-weight: bold; font-size: 1.2rem; }
  .vb-sticky-price { font-weight: 700; color: #000; font-size: 1.1rem;}
  .vb-sticky-atc { background: #000; color: #fff; border: none; padding: 12px 30px; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 1rem; text-transform: uppercase;}

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* ========================================= */
  /* LOWER FULL-WIDTH SECTIONS STYLES */
  /* ========================================= */
  .vb-sections-container {
    max-width: 1000px;
    margin: 5rem auto 8rem;
    padding: 0 20px;
    text-align: center;
  }

  .vb-section-block { margin-bottom: 6rem; }

  /* Headline Section */
  .vb-headline-block h2 {
    font-size: 2.8rem;
    line-height: 1.2;
    color: #111;
    font-weight: 800;
  }

  /* Icons Grid Section */
  .vb-icons-grid {
    display: flex;
    justify-content: center;
    gap: 4rem;
    flex-wrap: wrap;
  }
  .vb-icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    font-weight: bold;
    font-size: 1.1rem;
  }
  .vb-icon-emoji { font-size: 3.5rem; }

  /* How to Use Section */
  .vb-how-to-use-block h3 { font-size: 2.2rem; margin-bottom: 3rem; font-weight: 700;}
  .vb-steps-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2.5rem; text-align: left; }
  .vb-step-card {
    background: #fff;
    padding: 35px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08); /* Enhanced shadow for depth */
    border: 1px solid #f0f0f0;
    transition: transform 0.3s ease;
  }
  .vb-step-card:hover { transform: translateY(-5px); }

  /* Icon container - transparent background */
  .vb-step-icon-placeholder {
    width: 80px;
    height: 80px;
    background: transparent;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 20px;
  }
  .vb-step-icon-placeholder img { width: 100%; height: 100%; object-fit: contain; }
  .vb-step-text strong { display: block; font-size: 1.2rem; margin-bottom: 10px; }
  .vb-step-text p { color: #666; line-height: 1.5; }


  /* --- CROSS SELL SECTION --- */
  .vb-cross-sell-container { margin-top: 3rem; background: #f9f9f9; padding: 25px; border-radius: 12px; border: 1px solid #eee; }
  .vb-cross-sell-container h3 { margin-top: 0; font-size: 1.3rem; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
  .vb-cross-sell-wrapper { display: flex; gap: 20px; align-items: center; }
  .vb-cross-items { display: flex; align-items: center; gap: 15px; }
  .vb-cross-item img { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; background: #fff; }
  .vb-plus { font-size: 1.5rem; font-weight: bold; color: #888; }
  .vb-cross-info { flex: 1; display: flex; flex-direction: column; gap: 10px; }
  .vb-cross-total { font-size: 1.1rem; }
  .vb-btn-cross-add { background: #111; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 0.9rem;}
  .vb-btn-cross-add:hover { background: #333; }
  .vb-cross-note { font-size: 0.9rem; color: #555; margin: 0; line-height: 1.4;}
  .vb-small-price { color: #E53935; font-weight: 700; }

  /* --- INGREDIENTS VISUAL STYLES --- */
  .vb-ingredients-visual h3 { font-size: 2.2rem; margin-bottom: 3rem; font-weight: 700; }
  .vb-ingredients-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 3rem; margin-top: 2rem;
  }
  .vb-ingredient-card {
    display: flex; flex-direction: column; align-items: center; text-align: center;
  }
  .vb-ingredient-image-wrapper {
    width: 200px; height: 200px; border-radius: 50%; background: #fdfdfd;
    display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
    border: 1px solid #f0f0f0; box-shadow: 0 10px 20px rgba(0,0,0,0.03);
    overflow: hidden; transition: transform 0.3s ease;
  }
  .vb-ingredient-card:hover .vb-ingredient-image-wrapper { transform: scale(1.05); }
  .vb-ingredient-image-wrapper img { width: 85%; height: 85%; object-fit: contain; }
  .vb-ingredient-info h4 { margin: 10px 0; font-size: 1.4rem; color: #111; }
  .vb-ingredient-info p { color: #666; font-size: 1rem; line-height: 1.5; margin: 0;}

  /* --- RESPONSIVE DESIGN --- */
  @media (max-width: 900px) {
    .vb-cross-sell-wrapper { flex-direction: column; text-align: center; }
    .vb-cross-info { width: 100%; }
    .vb-btn-cross-add { width: 100%; }
    .vitalblend-wrapper { grid-template-columns: 1fr; gap: 3rem; }
    .vb-gallery { flex-direction: column-reverse; }
    .vb-thumbnails-column { flex-direction: row; width: 100%; overflow-x: auto; padding-bottom: 5px; }
    .vb-title { font-size: 2.5rem; }
    .vb-icons-grid { gap: 2rem; }
    .vb-steps-grid { grid-template-columns: 1fr; max-width: 500px; margin: 0 auto;}
    .vb-step-card { display: flex; align-items: flex-start; gap: 20px; padding: 25px;}
    .vb-step-icon-placeholder { margin-bottom: 0; width: 60px; height: 60px; flex-shrink: 0;}
    .vb-sticky-info { display: none; } /* Hide title/price on small mobile for space */
    .vb-ingredients-grid { grid-template-columns: 1fr; gap: 4rem; }
    .vb-ingredient-image-wrapper { width: 160px; height: 160px; }
  }
{% endstyle %}

<script>
  // Parse variant data stored in the Liquid script tag
  const productVariants = JSON.parse(document.getElementById('ProductVariantsJson').textContent);
  const mainImageEl = document.getElementById('ProductImage');
  
  // Initialize state
  let currentVariantPrice = {{ product.price }};
  let isSubscription = false;

  // --- NEW: FUNCTION TO HANDLE THUMBNAIL CLICKS ---
  function changeMainImage(newSrc, clickedBtn) {
    // 1. Update main image source
    mainImageEl.src = newSrc;
    
    // 2. Update active state on thumbnails
    document.querySelectorAll('.vb-thumb-btn').forEach(btn => btn.classList.remove('active'));
    clickedBtn.classList.add('active');
  }


  // --- FUNCTION TO HANDLE VARIANT CHANGES ---
  function updateVariantState(input) {
    // 1. Update visual label text
    const labelSpan = document.getElementById(`Label-${input.name}`);
    if(labelSpan) labelSpan.textContent = input.value;
    
    // 2. Find matching variant based on all selected radio inputs
    const selectedValues = Array.from(document.querySelectorAll('.vb-pill input:checked')).map(el => el.value);
    const matchedVariant = productVariants.find(variant => {
      return selectedValues.every(val => variant.options.includes(val));
    });
    
    if (matchedVariant) {
      // A. Update hidden ID for form submission
      document.getElementById('SelectedVariantId').value = matchedVariant.id;
      
      // B. Update base price variable
      currentVariantPrice = matchedVariant.price;
      
      // C. Update URL parameters silently
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('variant', matchedVariant.id);
      window.history.replaceState({}, '', newUrl);

      // D. UPDATE IMAGE & THUMBNAILS (Enhanced Logic)
      if (matchedVariant.featured_image && matchedVariant.featured_image.src) {
         let newImageSrc = matchedVariant.featured_image.src;
         if (newImageSrc.startsWith('http:')) newImageSrc = newImageSrc.replace('http:', 'https:');
         mainImageEl.src = newImageSrc;

         // Update Active Thumbnail Highlight
         const matchingThumbBtn = document.querySelector(`.vb-thumb-btn[data-media-id="${matchedVariant.featured_image.id}"]`);
         if (matchingThumbBtn) {
            document.querySelectorAll('.vb-thumb-btn').forEach(btn => btn.classList.remove('active'));
            matchingThumbBtn.classList.add('active');
         }
      } else if (matchedVariant.featured_media && matchedVariant.featured_media.preview_image) {
         // Some older or specific Shopify versions might use featured_media
         mainImageEl.src = matchedVariant.featured_media.preview_image.src;
      }

      // E. Refresh displayed prices
      updatePriceDisplay();

      // F. Update Dynamic Variant Highlights
      const highlightBox = document.getElementById('VariantHighlight');
      const highlightText = document.getElementById('VariantHighlightText');
      if (highlightBox && highlightText) {
        const vTitle = matchedVariant.title.toLowerCase();
        let benefit = "";
        
        if (vTitle.includes('vanilla') || vTitle.includes('vainilla')) {
          benefit = "Smooth & Creamy. Perfect for everyday shakes and baking.";
        } else if (vTitle.includes('cocoa') || vTitle.includes('chocolate')) {
          benefit = "Rich & Indulgent. The ultimate post-workout recovery flavor.";
        } else if (vTitle.includes('berry') || vTitle.includes('frutos')) {
          benefit = "Refreshing & Crisp. High antioxidant boost for your active days.";
        } else if (vTitle.includes('60') || vTitle.includes('90')) {
          benefit = "Optimized Supply. Consistent performance at the best value.";
        }
        
        if (benefit) {
          highlightText.innerText = benefit;
          highlightBox.style.display = 'flex';
        } else {
          highlightBox.style.display = 'none';
        }
      }
    }
  }

  // --- FUNCTION TO HANDLE SUBSCRIPTION TOGGLE ---
  function setPurchaseType(type) {
    const containerFreq = document.getElementById('SubscriptionFrequency');
    const optionOne = document.getElementById('OptionOneTime');
    const optionSub = document.getElementById('OptionSub');
    const selectFreq = containerFreq.querySelector('select');
    
    // Reset UI state
    optionOne.classList.remove('active');
    optionSub.classList.remove('active');

    if (type === 'subscription') {
      isSubscription = true;
      optionSub.classList.add('active');
      containerFreq.style.display = 'block';
      selectFreq.disabled = false;
      document.getElementById('PriceSub').style.color = '#E53935';
      document.getElementById('PriceOneTime').style.color = '#111';
    } else {
      isSubscription = false;
      optionOne.classList.add('active');
      containerFreq.style.display = 'none';
      selectFreq.disabled = true;
      document.getElementById('PriceOneTime').style.color = '#000';
      document.getElementById('PriceSub').style.color = '#111';
    }
    updatePriceDisplay();
  }

  // --- UPDATED PRICE DISPLAY SYNC ---
  function updatePriceDisplay() {
    const priceEl = document.getElementById('ProductPrice');
    const compareEl = document.getElementById('ComparePrice');
    const badgeEl = document.getElementById('SaveBadge');
    
    // Sync price labels inside the radio options
    const priceOneTimeLabel = document.getElementById('PriceOneTime');
    const priceSubLabel = document.getElementById('PriceSub');
    
    if (priceOneTimeLabel) priceOneTimeLabel.innerText = formatMoney(currentVariantPrice);
    if (priceSubLabel) priceSubLabel.innerText = formatMoney(currentVariantPrice * 0.9);
    
    let finalPrice = currentVariantPrice;

    if (isSubscription) {
      // Apply 10% discount simulation
      finalPrice = currentVariantPrice * 0.9; 
      compareEl.innerText = formatMoney(currentVariantPrice);
      compareEl.style.display = 'inline';
      badgeEl.style.display = 'inline-block';
    } else {
      compareEl.style.display = 'none';
      badgeEl.style.display = 'none';
    }
    priceEl.innerText = formatMoney(finalPrice);
  }

  // Helper utility for currency formatting
  function formatMoney(cents) { 
    return '$' + (cents / 100).toFixed(2); 
  }

  // --- TABS LOGIC ---
  function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("vb-tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
      tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("vb-tab-link");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).style.display = "block";
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  // --- STICKY BAR SCROLL LOGIC ---
  window.addEventListener('scroll', function() {
    const atcButton = document.getElementById('AddToCart');
    const stickyBar = document.getElementById('StickyBuyBar');
    if (!atcButton || !stickyBar) return;

    const atcPosition = atcButton.getBoundingClientRect().bottom;
    if (atcPosition < 0) {
      stickyBar.classList.add('visible');
    } else {
      stickyBar.classList.remove('visible');
    }
  });

  // Sync Sticky Price
  const originalUpdatePriceDisplay = updatePriceDisplay;
  updatePriceDisplay = function() {
    originalUpdatePriceDisplay();
    const stickyPrice = document.getElementById('StickyPrice');
    const mainPrice = document.getElementById('ProductPrice');
    if (stickyPrice && mainPrice) {
      stickyPrice.innerText = mainPrice.innerText;
    }
  };

  // --- CROSS SELL ADD TO CART ---
  function addCrossSellToCart(mainId, crossId) {
     const formData = {
       items: [
         { id: mainId, quantity: 1, selling_plan: isSubscription ? '{{ product.selected_selling_plan.id }}' : null }, 
         { id: crossId, quantity: 1 }
       ]
     };
     
     // Note: If subscription logic for main product is complex (requires specific selling_plan ID), 
     // we might need to fetch the selected plan ID from the main form. 
     // For this iteration, we keep it simple or assume one-time for cross-sell.
     
     fetch(window.Shopify.routes.root + 'cart/add.js', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(formData)
     })
     .then(response => {
       return response.json();
     })
     .then(data => {
        // Redirect to cart or open drawer
        window.location.href = '/cart';
     })
     .catch((error) => {
       console.error('Error:', error);
     });
  }
</script>

{% schema %}
{
  "name": "VitalBlend Product",
  "settings": [
    {
      "type": "header",
      "content": "Cross-Sell Settings"
    },
    {
      "type": "product",
      "id": "cross_sell_product",
      "label": "Frequently Bought Together Product"
    },
    {
      "type": "header",
      "content": "Subscription Settings"
    },
    {
      "type": "text",
      "id": "sub_text",
      "label": "Subscription Option Label",
      "default": "Subscribe & Save"
    },
    {
      "type": "text",
      "id": "sub_discount_badge",
      "label": "Discount Badge Text",
      "default": "Save 10%"
    },
    {
      "type": "header",
      "content": "Theme Colors"
    },
    {
      "type": "color",
      "id": "btn_color",
      "label": "Add to Cart Button Color",
      "default": "#000000"
    }
  ]
}
{% endschema %}
