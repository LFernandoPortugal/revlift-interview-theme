{% comment %}
  SECTION: MAIN VITALBLEND PRODUCT
  Description: Rebranded version maintaining high-fidelity UX.
{% endcomment %}

{%- assign selected_variant = product.selected_or_first_available_variant -%}

<div class="vb-product-wrapper">
  <!-- Media Gallery -->
  <div class="vb-gallery">
    {% if product.media.size > 1 %}
      <div class="vb-thumbnails">
        {% for media in product.media %}
          <button
            class="vb-thumb-btn {% if media.id == selected_variant.featured_media.id %}active{% endif %}"
            data-media-id="{{ media.id }}"
            onclick="changeMainImage('{{ media.preview_image | image_url: width: 1200 }}', this)"
          >
            <img
              src="{{ media.preview_image | image_url: width: 150, height: 150, crop: 'center' }}"
              width="75"
              height="75"
              loading="lazy"
              alt="{{ media.alt | escape }}"
            >
          </button>
        {% endfor %}
      </div>
    {% endif %}

    <div class="vb-main-image-container">
      <img
        id="ProductImage"
        src="{{ selected_variant.featured_image | default: product.featured_image | image_url: width: 1000 }}"
        width="1000"
        height="1000"
        alt="{{ product.title | escape }}"
        class="vb-main-image"
      >
    </div>
  </div>

  <!-- Product Info -->
  <div class="vb-info">
    <div class="vb-reviews">
      <span class="vb-stars" style="color: #FFB800;">â˜…â˜…â˜…â˜…â˜…</span>
      <span class="vb-review-count">1,240 REVIEWS</span>
    </div>

    <h1 class="vb-title">{{ product.title }}</h1>

    <div class="vb-price-container">
      <span id="ProductPrice" class="vb-price">{{ selected_variant.price | money }}</span>
      <span id="ComparePrice" class="vb-compare-price" style="display:none;"></span>
      <span id="SaveBadge" class="vb-save-badge" style="display:none;">SAVE 10%</span>
    </div>

    {% form 'product', product, id: 'product-form' %}
      <input type="hidden" name="id" id="SelectedVariantId" value="{{ selected_variant.id }}">

      <!-- Variant Selectors -->
      <div class="vb-options">
        {% for option in product.options_with_values %}
          <fieldset class="vb-option-group">
            <legend class="vb-option-label">
              {{ option.name }}: <span id="Label-{{ option.name }}">{{ option.selected_value }}</span>
            </legend>
            <div class="vb-pills">
              {% for value in option.values %}
                <label class="vb-pill">
                  <input
                    type="radio"
                    name="{{ option.name }}"
                    value="{{ value | escape }}"
                    {% if option.selected_value == value %}
                      checked
                    {% endif %}
                    onchange="updateVariantState()"
                  >
                  <span class="vb-pill-inner">
                    {% if option.name == 'Flavor' %}
                      <span class="vb-pill-icon">ðŸŒ¿</span>
                    {% endif %}
                    {{ value }}
                  </span>
                </label>
              {% endfor %}
            </div>
          </fieldset>
        {% endfor %}
      </div>

      <!-- Subscription Widget -->
      <div class="vb-purchase-type-container">
        <!-- One-time -->
        <label class="vb-purchase-option active" id="OptionOneTime" onclick="setPurchaseType('onetime')">
          <input type="radio" name="purchase_mode" value="onetime" checked style="display:none;">
          <div class="vb-radio-circle"></div>
          <div class="vb-option-content">
            <span class="vb-option-label-text">One-time purchase</span>
            <span class="vb-option-price" id="OneTimePriceDisplay">{{ selected_variant.price | money }}</span>
          </div>
        </label>

        <!-- Subscribe & Save -->
        <!-- Subscribe & Save -->
        <label class="vb-purchase-option" id="OptionSub" onclick="setPurchaseType('subscription')">
          <input type="radio" name="purchase_mode" value="subscription" style="display:none;">
          <div class="vb-radio-circle"></div>
          <div class="vb-option-content">
            <div class="vb-option-header">
              <span class="vb-option-label-text">Subscribe & Save</span>
              <span class="vb-option-badge">SAVE 10%</span>
            </div>
            <span class="vb-option-price" id="SubscriptionPriceDisplay">
              {{ selected_variant.price | times: 0.9 | money }}
            </span>
          </div>
        </label>

        <div id="SubscriptionDetails" class="vb-sub-details" style="display:none;">
          <div class="vb-frequency-selector">
            <label for="SellingPlan">DELIVER EVERY</label>
            <!-- Removed 'name' attribute so this select value is NOT submitted directly as 'selling_plan' -->
            <select id="SellingPlan" class="vb-select" onchange="updateSellingPlanId(this)">
              {%- if product.selling_plan_groups.size > 0 -%}
                {% for group in product.selling_plan_groups %}
                  {% for plan in group.selling_plans %}
                    <option value="{{ plan.id }}">{{ plan.name }}</option>
                  {% endfor %}
                {% endfor %}
              {%- else -%}
                <!-- Simulation Options -->
                <option value="sim_1_month">Every 1 Month</option>
                <option value="sim_2_months">Every 2 Months</option>
                <option value="sim_3_months">Every 3 Months</option>
              {%- endif -%}
            </select>

            <!-- Hidden input that holds the ACTUAL ID sent to Shopify -->
            <input type="hidden" name="selling_plan" id="RealSellingPlanId" value="">

            <!-- Hidden input for simulated frequency property -->
            <input type="hidden" name="properties[Subscription Frequency]" id="SimulatedFrequency" value="">

            <script>
              function updateSellingPlanId(select) {
                const val = select.value;
                const text = select.options[select.selectedIndex].text;
                const realInput = document.getElementById('RealSellingPlanId');
                const simInput = document.getElementById('SimulatedFrequency');

                if (val.startsWith('sim_')) {
                  // Simulation mode: Clear real ID, set property
                  realInput.value = '';
                  simInput.value = text;
                } else {
                  // Real mode: Set real ID, clear property
                  realInput.value = val;
                  simInput.value = '';
                }
              }

              // Initialize on load
              document.addEventListener('DOMContentLoaded', () => {
                const select = document.getElementById('SellingPlan');
                if (select) updateSellingPlanId(select);
              });
            </script>
          </div>

          <ul class="vb-benefits">
            <li><span>âœ“</span> Save 10% on every order</li>
            <li><span>âœ“</span> Free Shipping</li>
            <li><span>âœ“</span> Cancel anytime</li>
          </ul>
        </div>
      </div>

      <!-- Actions -->
      <div class="vb-actions">
        <div class="vb-quantity-selector">
          <button type="button" onclick="adjustQty(-1)" class="qty-btn">-</button>
          <input type="number" name="quantity" id="Quantity" value="1" min="1" readonly>
          <button type="button" onclick="adjustQty(1)" class="qty-btn">+</button>
        </div>
        <button type="submit" name="add" id="AddToCart" class="vb-btn-add">
          Add to Cart - <span id="ButtonPrice">{{ selected_variant.price | money }}</span>
        </button>
      </div>

      <div class="vb-description">
        {{ product.description }}
      </div>

      <script type="application/json" id="ProductVariantsJson">
        {{ product.variants | json }}
      </script>
    {% endform %}
  </div>
</div>

<!-- Supporting Sections -->
<div class="vb-extra-sections">
  {% if product.metafields.custom.promotional_headline != blank %}
    <h2 class="vb-section-headline">{{ product.metafields.custom.promotional_headline }}</h2>
  {% endif %}

  <!-- Icon Grid -->
  <div class="vb-icon-grid">
    <div class="vb-icon-item">
      <div class="vb-icon-circle">ðŸŒ±</div>
      <span>No filler ingredients</span>
    </div>
    <div class="vb-icon-item">
      <div class="vb-icon-circle">ðŸ”¥</div>
      <span>Low calorie</span>
    </div>
    <div class="vb-icon-item">
      <div class="vb-icon-circle">ðŸ’ª</div>
      <span>Nutrient dense</span>
    </div>
    <div class="vb-icon-item">
      <div class="vb-icon-circle">ðŸ‡ºðŸ‡¸</div>
      <span>Made in USA</span>
    </div>
  </div>

  <!-- How to Use -->
  <div class="vb-how-to-use">
    <h3>Simple Steps for Vitalblend</h3>
    <div class="vb-steps">
      <div class="vb-step">
        <div class="vb-step-image">1</div>
        <h4>Prepare</h4>
        <p>Measure the desired amount of Vitalblend for your routine.</p>
      </div>
      <div class="vb-step">
        <div class="vb-step-image">2</div>
        <h4>Mix</h4>
        <p>Incorporate easily into your preferred method of use.</p>
      </div>
      <div class="vb-step">
        <div class="vb-step-image">3</div>
        <h4>Enjoy</h4>
        <p>Repeat daily to see the full benefits of our formula.</p>
      </div>
    </div>
  </div>
</div>

<!-- Sticky Bar -->
<div id="StickyBar" class="vb-sticky-bar">
  <div class="sticky-container">
    <div class="sticky-product">
      <img src="{{ product.featured_image | image_url: width: 100 }}" width="50" height="50" alt="">
      <div class="sticky-text">
        <span class="sticky-title">{{ product.title }}</span>
        <span class="sticky-variant" id="StickyVariantLabel"></span>
      </div>
    </div>
    <div class="sticky-actions">
      <span class="sticky-price" id="StickyPrice"></span>
      <button type="button" onclick="document.getElementById('AddToCart').click()" class="vb-btn-add">
        Add to Cart
      </button>
    </div>
  </div>
</div>

{% style %}
  :root {
    --vb-red: #e53935;
    --vb-black: #1a1a1a;
    --vb-gray: #f5f5f5;
    --vb-border: #dddddd;
  }

  .vb-product-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 50px;
    max-width: 1300px;
    margin: 40px auto;
    padding: 0 30px;
    font-family: 'Outfit', sans-serif;
  }

  /* Gallery */
  .vb-gallery {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }
  .vb-thumbnails {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .vb-thumb-btn {
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 0;
    cursor: pointer;
    overflow: hidden;
    background: var(--vb-gray);
    width: 75px;
    height: 75px;
  }
  .vb-thumb-btn.active {
    border-color: var(--vb-black);
  }
  .vb-thumb-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .vb-main-image-container {
    flex: 1;
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    background: var(--vb-gray);
  }
  .vb-main-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.5s ease;
  }
  .vb-main-image-container:hover .vb-main-image {
    transform: scale(1.05);
  }

  /* Info */
  .vb-reviews {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .vb-title {
    font-size: 42px;
    font-weight: 800;
    margin: 0 0 15px;
    color: var(--vb-black);
    line-height: 1.1;
  }
  .vb-price {
    font-size: 28px;
    font-weight: 800;
    color: var(--vb-black);
  }

  /* Pills */
  .vb-option-label {
    font-size: 14px;
    font-weight: 800;
    text-transform: uppercase;
    margin-bottom: 12px;
    border: none;
    padding: 0;
  }
  .vb-option-group {
    border: none;
    padding: 0;
    margin-bottom: 25px;
  }
  .vb-pills {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .vb-pill input {
    display: none;
  }
  .vb-pill-inner {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: 1px solid var(--vb-border);
    border-radius: 50px;
    cursor: pointer;
    font-weight: 700;
    transition: 0.2s;
  }
  .vb-pill input:checked + .vb-pill-inner {
    background: var(--vb-black);
    color: white;
    border-color: var(--vb-black);
  }

  /* Subscription Widget */
  .vb-purchase-type-container {
    border: 1px solid var(--vb-border);
    border-radius: 12px;
    margin: 30px 0;
    overflow: hidden;
  }
  .vb-purchase-option {
    display: flex;
    align-items: center;
    padding: 20px;
    cursor: pointer;
    background: white;
    transition: 0.2s;
    border-bottom: 1px solid var(--vb-border);
  }
  .vb-purchase-option:last-child {
    border-bottom: none;
  }
  .vb-purchase-option.active {
    background: #faf9f6;
  }

  .vb-radio-circle {
    width: 22px;
    height: 22px;
    border: 2px solid var(--vb-border);
    border-radius: 50%;
    margin-right: 15px;
    position: relative;
  }
  .vb-purchase-option.active .vb-radio-circle {
    border-color: var(--vb-black);
  }
  .vb-purchase-option.active .vb-radio-circle::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    width: 10px;
    height: 10px;
    background: var(--vb-black);
    border-radius: 50%;
  }

  .vb-option-content {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .vb-option-label-text {
    font-weight: 800;
    font-size: 16px;
  }
  .vb-option-price {
    font-weight: 800;
    font-size: 16px;
  }
  .vb-option-badge {
    background: var(--vb-red);
    color: white;
    font-size: 10px;
    font-weight: 900;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: 10px;
  }

  .vb-sub-details {
    padding: 20px;
    background: #f1f0e8;
    border-top: 1px solid var(--vb-border);
  }
  .vb-frequency-selector label {
    display: block;
    font-size: 11px;
    font-weight: 900;
    margin-bottom: 5px;
  }
  .vb-select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--vb-border);
    border-radius: 8px;
    font-weight: 700;
  }

  .vb-benefits {
    list-style: none;
    padding: 0;
    margin: 15px 0 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .vb-benefits li {
    font-size: 13px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .vb-benefits li span {
    color: #43a047;
    font-weight: 900;
  }

  /* Actions */
  .vb-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  .vb-quantity-selector {
    display: flex;
    align-items: center;
    border: 1px solid var(--vb-border);
    border-radius: 50px;
    padding: 5px;
  }
  .qty-btn {
    background: none;
    border: none;
    width: 40px;
    height: 40px;
    cursor: pointer;
    font-size: 20px;
    font-weight: 700;
  }
  .vb-quantity-selector input {
    border: none;
    width: 30px;
    text-align: center;
    font-size: 16px;
    font-weight: 700;
    -moz-appearance: textfield;
  }
  .vb-quantity-selector input::-webkit-outer-spin-button,
  .vb-quantity-selector input::-webkit-inner-spin-button {
    -webkit-appearance: none;
  }

  .vb-btn-add {
    background: var(--vb-red);
    color: white;
    border: none;
    flex: 1;
    padding: 18px;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 900;
    text-transform: uppercase;
    cursor: pointer;
    transition: 0.2s;
  }
  .vb-btn-add:hover {
    filter: brightness(1.1);
  }

  /* Extra Sections */
  .vb-extra-sections {
    max-width: 1000px;
    margin: 80px auto;
    padding: 0 20px;
    text-align: center;
  }
  .vb-section-headline {
    font-size: 48px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 60px;
  }

  .vb-icon-grid {
    display: flex;
    justify-content: center;
    gap: 50px;
    margin-bottom: 80px;
    flex-wrap: wrap;
  }
  .vb-icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    font-weight: 800;
    font-size: 14px;
    width: 150px;
  }
  .vb-icon-circle {
    width: 80px;
    height: 80px;
    background: var(--vb-gray);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 35px;
  }

  .vb-how-to-use h3 {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 40px;
  }
  .vb-steps {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
    text-align: center;
  }
  .vb-step-image {
    width: 60px;
    height: 60px;
    background: var(--vb-black);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-weight: 900;
    font-size: 24px;
  }
  .vb-step h4 {
    font-size: 20px;
    font-weight: 900;
    margin: 0 0 10px;
    text-transform: uppercase;
  }
  .vb-step p {
    color: #666;
    font-size: 15px;
    line-height: 1.5;
  }

  /* Sticky Bar */
  .vb-sticky-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: white;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 15px 0;
    transform: translateY(-100%);
    transition: 0.3s;
  }
  .vb-sticky-bar.visible {
    transform: translateY(0);
  }
  .sticky-container {
    max-width: 1300px;
    margin: 0 auto;
    padding: 0 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .sticky-product {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .sticky-text {
    display: flex;
    flex-direction: column;
  }
  .sticky-title {
    font-weight: 800;
    font-size: 16px;
  }
  .sticky-variant {
    font-size: 12px;
    color: #666;
  }
  .sticky-actions {
    display: flex;
    align-items: center;
    gap: 30px;
  }
  .sticky-price {
    font-weight: 800;
    font-size: 20px;
  }
  .sticky-actions .vb-btn-add {
    padding: 12px 30px;
    font-size: 14px;
  }

  @media (max-width: 900px) {
    .vb-product-wrapper {
      grid-template-columns: 1fr;
    }
    .vb-gallery {
      flex-direction: column-reverse;
    }
    .vb-thumbnails {
      flex-direction: row;
    }
    .vb-steps {
      grid-template-columns: 1fr;
    }
    .vb-sticky-bar {
      display: none;
    }
  }
{% endstyle %}

<script>
  const productVariants = JSON.parse(document.getElementById('ProductVariantsJson').textContent);
  let isSubscription = false;

  function adjustQty(amount) {
    const input = document.getElementById('Quantity');
    let val = parseInt(input.value) + amount;
    if (val < 1) val = 1;
    input.value = val;
  }

  function changeMainImage(src, btn) {
    document.getElementById('ProductImage').src = src;
    document.querySelectorAll('.vb-thumb-btn').forEach((b) => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function updateVariantState() {
    const selectedValues = Array.from(document.querySelectorAll('.vb-pill input:checked')).map((el) => el.value);
    const matchedVariant = productVariants.find((variant) => {
      return selectedValues.every((val) => variant.options.includes(val));
    });

    if (matchedVariant) {
      document.getElementById('SelectedVariantId').value = matchedVariant.id;

      // Update price displays
      const basePrice = matchedVariant.price;
      const subPrice = basePrice * 0.9;

      document.getElementById('OneTimePriceDisplay').innerText = formatMoney(basePrice);
      document.getElementById('SubscriptionPriceDisplay').innerText = formatMoney(subPrice);

      // Update labels
      document.querySelectorAll('.vb-option-group').forEach((group) => {
        const name = group.querySelector('legend').innerText.split(':')[0].trim();
        const span = document.getElementById(`Label-${name}`);
        const checked = group.querySelector('input:checked');
        if (span && checked) span.innerText = checked.value;
      });

      // Update images
      if (matchedVariant.featured_media) {
        const btn = document.querySelector(`.vb-thumb-btn[data-media-id="${matchedVariant.featured_media.id}"]`);
        if (btn) btn.click();
      }

      updateActivePrice();
      updateStickyBar(matchedVariant);
    }
  }

  function setPurchaseType(type) {
    isSubscription = type === 'subscription';
    document.getElementById('OptionOneTime').classList.toggle('active', !isSubscription);
    document.getElementById('OptionSub').classList.toggle('active', isSubscription);

    const subDetails = document.getElementById('SubscriptionDetails');
    if (subDetails) subDetails.style.display = isSubscription ? 'block' : 'none';

    updateActivePrice();
  }

  function updateActivePrice() {
    const variantId = document.getElementById('SelectedVariantId').value;
    const variant = productVariants.find((v) => v.id == variantId);
    let price = variant.price;
    if (isSubscription) price = price * 0.9;

    document.getElementById('ProductPrice').innerText = formatMoney(price);
    document.getElementById('ButtonPrice').innerText = formatMoney(price);
  }

  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  function updateStickyBar(variant) {
    document.getElementById('StickyPrice').innerText = document.getElementById('ProductPrice').innerText;
    document.getElementById('StickyVariantLabel').innerText = variant.title;
  }

  // Sticky Bar Logic
  window.onscroll = function () {
    const bar = document.getElementById('StickyBar');
    const trigger = document.getElementById('AddToCart').getBoundingClientRect().bottom;
    if (trigger < 0) {
      bar.classList.add('visible');
    } else {
      bar.classList.remove('visible');
    }
  };

  // Initial call
  updateVariantState();
</script>

{% schema %}
{
  "name": "Vitalblend Product",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    }
  ]
}
{% endschema %}
